<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timetable Generator</title>
<style>
  :root {
    --primary: #004085;
    --danger: #dc3545;
    --light-grey: #f8f9fa;
    --info: #17a2b8;
    --medium-blue: #0069d9;
    --success: #28a745;
    --warning: #ffc107;
    --text: #004085;
    --muted: #666;
    --border: #004085;
    --card: white;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(135deg, rgba(248,249,250,0.95) 0%, rgba(233,236,239,0.9) 100%);color:var(--primary);font:400 14px/1.5 'Segoe UI',Arial,sans-serif;min-height:100vh;backdrop-filter:blur(10px)}
  .container{max-width:100%;margin:0;padding:10px;position:relative}
  
  /* Header */
  .header{background:linear-gradient(135deg, rgba(0,64,133,0.95) 0%, rgba(0,86,179,0.9) 100%);padding:25px;border-radius:16px;margin-bottom:25px;text-align:center;backdrop-filter:blur(15px);box-shadow:0 8px 32px rgba(0,64,133,0.2);border:1px solid rgba(255,255,255,0.1)}
  .header h1{margin:0;font-size:32px;font-weight:700;color:#fff;text-shadow:0 2px 4px rgba(0,0,0,0.3)}
  .header p{margin:8px 0 0;color:rgba(255,255,255,.85);font-size:15px}
  
  /* Layout */
  .grid{display:flex;flex-direction:column;gap:40px;max-width:100%;margin:0;padding:0 20px}
  @media(min-width:1024px){.grid{flex-direction:row;align-items:flex-start;padding:0 10px}}
  .setup-section{flex:0 0 280px;display:flex;flex-direction:column;gap:8px}
  .timetable-section{flex:1;min-width:0;margin-left:20px}
  @media(max-width:960px){.grid{flex-direction:column}.timetable-section{margin-left:0}}
  
  /* Cards */
  .card{background:rgba(255,255,255,0.85);border:1px solid rgba(0,64,133,0.1);border-radius:12px;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,0.08);backdrop-filter:blur(10px);margin-bottom:15px}
  .card h2{margin:0 0 12px;font-size:18px;color:var(--primary);font-weight:600;text-align:center;padding-bottom:6px;border-bottom:2px solid rgba(0,64,133,0.1)}
  
  /* Form Elements */
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px;font-weight:500}
  input,select,textarea{width:100%;padding:8px 12px;border:1px solid rgba(0,64,133,0.2);background:rgba(255,255,255,0.9);color:var(--primary);border-radius:8px;font-size:13px;outline:none;transition:all .3s ease;backdrop-filter:blur(5px)}
  input:focus,select:focus{border-color:var(--info);box-shadow:0 0 0 3px rgba(23,162,184,.15);background:rgba(255,255,255,0.95);transform:translateY(-1px)}
  
  /* Buttons */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border:1px solid rgba(0,64,133,0.2);background:rgba(255,255,255,0.9);color:var(--primary);border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;transition:all .3s ease;text-decoration:none;backdrop-filter:blur(5px);box-shadow:0 4px 16px rgba(0,0,0,0.05)}
  .btn:hover{background:rgba(233,236,239,0.95);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
  .btn.small{padding:4px 8px;font-size:12px}
  #saveConfig{background:var(--primary);color:white;border-color:var(--primary)}
  #saveConfig:hover{background:#0056b3}
  #viewDatabase{background:var(--medium-blue);color:white;border-color:var(--medium-blue)}
  #viewDatabase:hover{background:var(--primary)}
  #generate{background:var(--info);color:white;border-color:var(--info)}
  #generate:hover{background:#138496}
  #clear{background:var(--warning);color:var(--primary);border-color:var(--warning)}
  #clear:hover{background:#e0a800}
  #downloadCSV{background:var(--success);color:white;border-color:var(--success)}
  #downloadCSV:hover{background:#218838}
  #printBtn{background:var(--warning);color:var(--primary);border-color:var(--warning)}
  #printBtn:hover{background:#e0a800}
  #conflictsBtn{background:var(--info);color:white;border-color:var(--info)}
  #conflictsBtn:hover{background:#138496}
  #modalSave{background:var(--primary);color:white;border-color:var(--primary)}
  #modalSave:hover{background:#0056b3}
  
  /* Layout helpers */
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;align-items:end}
  .row-6{display:grid;grid-template-columns:1fr 1fr 80px 1fr 1fr 80px;gap:8px;margin:8px 0;align-items:end}
  .flex{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;align-items:center;justify-content:center}
  
  /* Table */
  .table-wrap{overflow:auto;border-radius:16px;border:1px solid rgba(0,64,133,0.1);margin-top:20px;background:rgba(255,255,255,0.9);box-shadow:0 8px 32px rgba(0,0,0,0.08);backdrop-filter:blur(10px)}
  table{width:100%;border-collapse:collapse;min-width:600px;background:transparent;border-radius:16px;overflow:hidden}
  th,td{padding:20px 18px;font-size:14px;text-align:center;vertical-align:middle;border:none;position:relative}
  th{background:linear-gradient(135deg,rgba(0,64,133,0.95) 0%,rgba(0,86,179,0.9) 100%);color:#fff;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);backdrop-filter:blur(5px)}
  tbody tr{transition:all 0.3s ease}
  tbody tr:hover{background:rgba(248,249,250,0.8);transform:translateY(-1px)}
  tbody td{background:rgba(255,255,255,0.6);color:var(--primary);font-weight:500;transition:all 0.3s ease;backdrop-filter:blur(3px)}
  tbody td:first-child{background:linear-gradient(135deg,rgba(23,162,184,0.95) 0%,rgba(19,132,150,0.9) 100%);color:#fff;font-weight:600;text-shadow:0 2px 4px rgba(0,0,0,0.3);backdrop-filter:blur(5px)}
  tbody tr:hover td:first-child{background:linear-gradient(135deg,rgba(19,132,150,0.95) 0%,rgba(0,64,133,0.9) 100%);transform:scale(1.02)}
  
  /* Chips */
  .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:16px;background:linear-gradient(135deg,rgba(40,167,69,0.9) 0%,rgba(40,167,69,0.7) 100%);font-size:12px;color:#fff;font-weight:500;backdrop-filter:blur(5px);box-shadow:0 4px 12px rgba(40,167,69,0.2);border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease}
  .chip:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(40,167,69,0.3)}
  
  /* Section titles */
  .section-title{font-weight:600;margin:16px 0 12px;color:var(--primary);font-size:18px;padding:12px 20px;background:linear-gradient(135deg,rgba(255,193,7,0.9) 0%,rgba(255,193,7,0.7) 100%);border-radius:12px;text-align:center;backdrop-filter:blur(5px);box-shadow:0 4px 16px rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.3)}
  
  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(8px)}
  .modal{background:rgba(255,255,255,0.95);border:1px solid rgba(0,64,133,0.2);border-radius:20px;padding:30px;min-width:450px;max-width:650px;color:var(--primary);box-shadow:0 20px 60px rgba(0,0,0,0.15);backdrop-filter:blur(15px)}
  .modal h3{margin:0 0 16px;color:var(--primary)}
  
  /* Utilities */
  .notice{font-size:13px;color:var(--success);background:rgba(255,255,255,0.9);padding:16px;border-radius:12px;border-left:4px solid var(--success);margin:16px 0;border:1px solid rgba(233,236,239,0.5);backdrop-filter:blur(5px);box-shadow:0 4px 16px rgba(40,167,69,0.1)}
  .hint{font-size:12px;color:var(--muted);background:rgba(255,255,255,0.8);padding:10px;border-radius:8px;margin:8px 0;border:1px solid rgba(233,236,239,0.5);backdrop-filter:blur(3px)}
  .footer{color:var(--muted);font-size:13px;text-align:center;margin:25px 0;padding:20px;background:rgba(255,255,255,0.8);border-radius:16px;border:1px solid rgba(0,64,133,0.1);backdrop-filter:blur(5px)}
  .muted-small{font-size:12px;color:var(--muted)}
  .edit-row{display:flex;gap:8px;align-items:center;margin:8px 0}
  .edit-row label{width:80px;margin:0}
  .color-box{width:16px;height:16px;border-radius:3px;display:inline-block;border:1px solid var(--border)}
  
  /* Animations */
  @keyframes float{0%,100%{transform:translateY(0px)}50%{transform:translateY(-10px)}}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
  @keyframes shine{0%{transform:translateX(-100%) translateY(-100%) rotate(45deg)}100%{transform:translateX(100%) translateY(100%) rotate(45deg)}}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
  @keyframes glow{0%,100%{box-shadow:0 0 5px rgba(0,64,133,0.3)}50%{box-shadow:0 0 20px rgba(0,64,133,0.6)}}
  
  /* Enhanced interactions */
  .card{animation:fadeInUp 0.8s ease-out}
  .card:nth-child(2){animation-delay:0.3s}
  .card:nth-child(3){animation-delay:0.6s}
  .btn{position:relative;z-index:1;overflow:hidden}
  .btn *{position:relative;z-index:2}
  .btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent);transition:left 0.5s;z-index:1}
  .btn:hover::before{left:100%}
  .header{animation:slideIn 1s ease-out}
  tbody td[data-empty='0']{animation:glow 2s infinite}
  
  /* Enhanced input animations */
  input:focus{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,64,133,0.2)!important}
  input:hover{transform:translateY(-1px)}
  
  /* Timing section animations */
  @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
  button[onclick="generateTimeSlots()"]:hover::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,0.3) 50%,transparent 70%);background-size:200% 100%;animation:shimmer 1s ease-in-out}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
        <a href="page.htm" style="color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2); border-radius: 6px; font-size: 14px;">‚Üê Back</a>
        <h1 style="margin: 0;">üéì Timetable Generator</h1>
        <div style="width: 80px;"></div>
      </div>
    </div>

    <div class="grid">
      <div class="card setup-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <h2 style="font-size:22px;margin:0">‚öôÔ∏è Setup</h2>
          <div style="display:flex;gap:4px">
            <button id="saveConfig" class="btn small" style="padding:6px 10px;font-size:15px">üíæ</button>
            <button id="loadConfig" class="btn small" style="padding:6px 10px;font-size:15px">üìÅ</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 60px;gap:6px;margin:4px 0;align-items:end">
          <div style="display:flex;flex-direction:column">
            <label style="margin-bottom:3px;font-weight:600;color:var(--primary);font-size:16px">üìÖ Days</label>
            <select id="days" style="padding:8px 10px;font-size:16px">
              <option value="Mon,Tue,Wed,Thu,Fri">Mon-Fri</option>
              <option value="Mon,Tue,Wed,Thu,Fri,Sat">Mon-Sat</option>
              <option value="Tue,Wed,Thu,Fri,Sat,Sun">Tue-Sun</option>
              <option value="Mon,Tue,Wed,Thu,Fri,Sat,Sun">All </option>
            </select>
          </div>
          <div style="display:flex;flex-direction:column">
            <label style="margin-bottom:3px;font-weight:600;color:var(--primary);font-size:16px">‚è∞ Periods</label>
            <input id="periodCount" type="number" min="1" max="12" value="6" style="padding:8px 10px;font-size:16px"/>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 60px;gap:6px;margin:4px 0;align-items:end">
          <div style="display:flex;flex-direction:column">
            <label style="margin-bottom:3px;font-weight:600;color:var(--primary);font-size:16px">üè´ Sections</label>
            <input id="sections" value="A,B" style="padding:8px 10px;font-size:16px"/>
          </div>
          <div style="display:flex;flex-direction:column">
            <label style="margin-bottom:3px;font-weight:600;color:var(--primary);font-size:16px">üçΩÔ∏è Lunch</label>
            <input id="lunchIndex" type="number" min="1" value="3" style="padding:8px 10px;font-size:16px"/>
          </div>
        </div>

        <div style="background:linear-gradient(135deg,rgba(255,255,255,0.9) 0%,rgba(248,249,250,0.8) 100%);padding:16px;border-radius:16px;border:2px solid rgba(0,64,133,0.1);box-shadow:0 8px 32px rgba(0,64,133,0.1);backdrop-filter:blur(10px);margin:8px 0">
          <div style="text-align:center;margin-bottom:12px;padding:8px;background:linear-gradient(135deg,rgba(0,64,133,0.1) 0%,rgba(23,162,184,0.1) 100%);border-radius:12px;border:1px solid rgba(0,64,133,0.1)">
            <h3 style="margin:0;font-size:18px;color:var(--primary);font-weight:700">‚è±Ô∏è Schedule Configuration</h3>
            <p style="margin:4px 0 0;font-size:12px;color:var(--muted)">üáÆüá≥ Indian Time Format (AM/PM)</p>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
            <div style="background:linear-gradient(135deg,rgba(255,193,7,0.1) 0%,rgba(255,193,7,0.05) 100%);padding:12px;border-radius:12px;border:1px solid rgba(255,193,7,0.2)">
              <label style="display:block;font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">üåÖ Start Time</label>
              <div style="position:relative">
                <input id="startTime" placeholder="9" value="9" style="width:100%;padding:12px 40px 12px 12px;font-size:16px;font-weight:600;border:2px solid rgba(255,193,7,0.3);border-radius:10px;background:rgba(255,255,255,0.9);color:var(--primary);transition:all 0.3s ease" title="Start time (e.g., 9 for 9 AM)"/>
                <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;color:#f59e0b">üåÖ</span>
              </div>
            </div>
            <div style="background:linear-gradient(135deg,rgba(220,53,69,0.1) 0%,rgba(220,53,69,0.05) 100%);padding:12px;border-radius:12px;border:1px solid rgba(220,53,69,0.2)">
              <label style="display:block;font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">üåá End Time</label>
              <div style="position:relative">
                <input id="endTime" placeholder="4" value="4" style="width:100%;padding:12px 40px 12px 12px;font-size:16px;font-weight:600;border:2px solid rgba(220,53,69,0.3);border-radius:10px;background:rgba(255,255,255,0.9);color:var(--primary);transition:all 0.3s ease" title="End time (e.g., 4 for 4 PM)"/>
                <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;color:#dc3545">üåá</span>
              </div>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
            <div style="background:linear-gradient(135deg,rgba(40,167,69,0.1) 0%,rgba(40,167,69,0.05) 100%);padding:12px;border-radius:12px;border:1px solid rgba(40,167,69,0.2)">
              <label style="display:block;font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">‚òï Short Break</label>
              <div style="position:relative">
                <input id="shortBreak" placeholder="11-11.15" value="11-11.15" style="width:100%;padding:12px 40px 12px 12px;font-size:14px;font-weight:500;border:2px solid rgba(40,167,69,0.3);border-radius:10px;background:rgba(255,255,255,0.9);color:var(--primary);transition:all 0.3s ease" title="Short break (e.g., 11-11.15)"/>
                <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;color:#28a745">‚òï</span>
              </div>
            </div>
            <div style="background:linear-gradient(135deg,rgba(23,162,184,0.1) 0%,rgba(23,162,184,0.05) 100%);padding:12px;border-radius:12px;border:1px solid rgba(23,162,184,0.2)">
              <label style="display:block;font-size:13px;font-weight:600;color:var(--primary);margin-bottom:6px">üçΩÔ∏è Lunch Break</label>
              <div style="position:relative">
                <input id="lunchBreak" placeholder="1.15-2" value="1.15-2" style="width:100%;padding:12px 40px 12px 12px;font-size:14px;font-weight:500;border:2px solid rgba(23,162,184,0.3);border-radius:10px;background:rgba(255,255,255,0.9);color:var(--primary);transition:all 0.3s ease" title="Lunch break (e.g., 1.15-2)"/>
                <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:16px;color:#17a2b8">üçΩÔ∏è</span>
              </div>
            </div>
          </div>
          
          <div style="text-align:center;margin-bottom:12px">
            <button type="button" onclick="generateTimeSlots()" style="padding:14px 24px;font-size:16px;font-weight:700;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#ec4899 100%);color:white;border:none;border-radius:12px;cursor:pointer;box-shadow:0 8px 25px rgba(99,102,241,0.4);transition:all 0.3s ease;position:relative;overflow:hidden" onmouseover="this.style.transform='translateY(-2px) scale(1.05)';this.style.boxShadow='0 12px 35px rgba(99,102,241,0.6)'" onmouseout="this.style.transform='translateY(0) scale(1)';this.style.boxShadow='0 8px 25px rgba(99,102,241,0.4)'">‚ö° Generate Schedule ‚ö°</button>
          </div>
          
          <div style="background:rgba(248,249,250,0.9);border-radius:12px;border:2px solid rgba(0,64,133,0.1);overflow:hidden">
            <div style="background:linear-gradient(135deg,var(--primary) 0%,var(--info) 100%);color:white;padding:8px 12px;font-size:13px;font-weight:600;text-align:center">üìã Generated Schedule Preview</div>
            <div id="periodLabels" style="width:100%;padding:12px;font-size:13px;min-height:120px;border:none;background:transparent;line-height:1.5;color:var(--primary);overflow-y:auto;max-height:200px">Click Generate Schedule to see timing preview...</div>
          </div>
        </div>
  


      </div>
      
      <div class="card setup-section">
        <div style="text-align:center;padding:12px;border:2px dashed rgba(0,64,133,0.3);border-radius:8px;margin-bottom:12px;background:rgba(255,255,255,0.7)">
          <p style="margin:0 0 8px;color:var(--muted);font-size:14px;font-weight:500">üìö Manage Subjects</p>
          <button id="viewDatabase" class="btn" style="padding:8px 16px;font-size:14px">üóÑÔ∏è View Database</button>
        </div>
        <h2 style="margin:0 0 12px;font-size:18px;color:var(--primary);font-weight:600;text-align:center;padding-bottom:6px;border-bottom:2px solid rgba(0,64,133,0.1)">üìã Selected Subjects</h2>
        <div id="selectedSubjects" style="max-height:200px;overflow-y:auto"></div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:12px 0 6px">
          <button id="generate" class="btn" style="justify-self:stretch;padding:8px 12px;font-size:16px;font-weight:600;background:var(--success);color:white">‚ö° Generate</button>
          <button id="clear" class="btn" style="justify-self:stretch;padding:8px 12px;font-size:16px;font-weight:600">üóëÔ∏è Clear</button>
        </div>

        <div class="notice" style="padding:6px;margin:4px 0;font-size:14px">
          üí° Labs use 2 consecutive periods. Theory in morning, labs in afternoon.
        </div>
      </div>

      <div class="card timetable-section">
        <div style="display:flex;flex-direction:column;gap:15px;margin-bottom:25px">
          <h2 style="text-align:center;margin:0">Timetable</h2>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:450px;margin:0 auto">
            <button id="downloadCSV" class="btn small" style="padding:10px 16px">üì• CSV</button>
            <button id="printBtn" class="btn small" style="padding:10px 16px">üñ®Ô∏è Print</button>
            <button id="conflictsBtn" class="btn small" style="padding:10px 16px">‚ö†Ô∏è Conflicts</button>
          </div>
        </div>
        
        <div id="status" class="hint">Ready to generate...</div>
        <div id="legend" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:24px 0;justify-items:center;padding:16px;background:rgba(255,255,255,0.6);border-radius:12px;backdrop-filter:blur(5px);border:1px solid rgba(0,64,133,0.1)"></div>
        <div id="tables"></div>
      </div>
    </div>

    <div class="footer">
      Made by Kavya and suravi
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div id="modalContent"></div>
      <div style="display:flex;gap:8px;margin-top:16px;justify-content:flex-end">
        <button id="modalCancel" class="btn">Cancel</button>
        <button id="modalSave" class="btn">Save</button>
      </div>
    </div>
  </div>

<script>
  const byId = id => document.getElementById(id);
  const subjectRows = byId('subjectRows');

  function escapeHtml(s){
    return (s+'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function toHexColor(c){
    if(!c) return '#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0');
    if(/^#/.test(c)) return c;
    return '#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0');
  }

  let selectedSubjectsData = [];

  function displaySelectedSubjects(){
    const container = byId('selectedSubjects');
    if(!selectedSubjectsData.length){
      container.innerHTML = '<div class="hint">No subjects selected. Use View Database to select subjects.</div>';
      return;
    }
    container.innerHTML = `
      <div style="background:rgba(255,255,255,0.9);border-radius:16px;padding:20px;margin:12px 0;border:1px solid rgba(0,64,133,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.08);backdrop-filter:blur(10px)">
        <div style="font-weight:600;margin-bottom:16px;color:var(--primary);font-size:16px;text-align:center;padding-bottom:8px;border-bottom:2px solid rgba(0,64,133,0.1)">üìö Selected Subjects (${selectedSubjectsData.length})</div>
        ${selectedSubjectsData.map((s, i) => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin:6px 0;background:rgba(255,255,255,0.9);border-radius:8px;border:1px solid rgba(0,64,133,0.1);box-shadow:0 2px 8px rgba(0,0,0,0.05)">
            <div style="flex:1">
              <span style="color:var(--primary);font-weight:500;font-size:16px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(s.name)}">${i+1}. ${escapeHtml(s.name)}</span>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <input type="text" value="${s.teachers || ''}" onchange="updateTeachers(${i}, this.value)" placeholder="Teacher names" style="width:140px;padding:6px 8px;border:1px solid rgba(0,64,133,0.3);border-radius:6px;font-size:14px">
              <span style="font-size:11px;color:var(--muted)">üë®‚Äçüè´</span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  function updateTeachers(index, teachers) {
    selectedSubjectsData[index].teachers = teachers.trim();
    displaySelectedSubjects();
  }
  
  function removeSubject(index) {
    selectedSubjectsData.splice(index, 1);
    displaySelectedSubjects();
    byId('status').textContent = `üóëÔ∏è Subject removed. ${selectedSubjectsData.length} subjects remaining.`;
  }

  function getSetup(){
    const days = byId('days').value.split(',').map(s=>s.trim()).filter(Boolean);
    const periodCount = Math.max(1, Math.min(12, parseInt(byId('periodCount').value||'6',10)));
    const labelsRaw = byId('periodLabels').value.trim();
    let periodLabels = labelsRaw ? labelsRaw.split(',').map(s=>s.trim()).filter(Boolean) : Array.from({length:periodCount},(_,i)=>`Period ${i+1}`);
    if(periodLabels.length !== periodCount) periodLabels = Array.from({length:periodCount},(_,i)=>periodLabels[i]||`Period ${i+1}`);

    const sections = byId('sections').value.split(',').map(s=>s.trim()).filter(Boolean);
    let lunchIndex = parseInt(byId('lunchIndex').value||'3',10);
    if(isNaN(lunchIndex)) lunchIndex = 3;
    lunchIndex = Math.max(1, Math.min(periodCount-1, lunchIndex));

    const subs = selectedSubjectsData;

    return { days, periodCount, periodLabels, sections, lunchIndex, subs };
  }

  function buildLegend(subs){
    const leg = byId('legend'); 
    leg.innerHTML = '';
    subs.forEach(s=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML = `<i style="background:${s.color};width:8px;height:8px;border-radius:50%;display:inline-block"></i> ${escapeHtml(s.name)}`;
      leg.appendChild(chip);
    });
  }

  function generateActualTimeSlots() {
    const startTime = parseFloat(byId('startTime').value) || 9;
    const endTime = parseFloat(byId('endTime').value) || 4;
    const shortBreak = byId('shortBreak').value.trim() || '11-11.15';
    const lunchBreak = byId('lunchBreak').value.trim() || '1.15-2';
    
    const slots = [];
    let currentHour = startTime;
    
    // Parse break times
    const breaks = [];
    if(shortBreak) {
      const [start, end] = shortBreak.split('-').map(t => parseFloat(t.trim()));
      breaks.push({ start, end, label: 'SHORT BREAK' });
    }
    if(lunchBreak) {
      const [start, end] = lunchBreak.split('-').map(t => {
        let time = parseFloat(t.trim());
        if(time < 12 && time >= 1) time += 12;
        return time;
      });
      breaks.push({ start, end, label: 'LUNCH BREAK' });
    }
    
    while(currentHour < (endTime <= 12 ? endTime + 12 : endTime)) {
      // Check for breaks
      const breakAtTime = breaks.find(b => Math.abs(currentHour - b.start) < 0.01);
      if(breakAtTime) {
        slots.push({
          start: formatTime(breakAtTime.start),
          end: formatTime(breakAtTime.end),
          label: breakAtTime.label,
          type: 'break'
        });
        currentHour = breakAtTime.end;
      } else {
        const nextHour = currentHour + 1;
        slots.push({
          start: formatTime(currentHour),
          end: formatTime(nextHour),
          label: `${formatTime(currentHour)} to ${formatTime(nextHour)}`,
          type: 'period'
        });
        currentHour = nextHour;
      }
    }
    
    return slots;
  }

  function generateTimetable(){
    const { days, sections, subs } = getSetup();
    if(!days.length || !subs.length || !sections.length) return;

    const timeSlots = generateActualTimeSlots();
    const grids = sections.map(() => Array.from({length: days.length}, () => Array(timeSlots.length).fill(null)));
    
    sections.forEach((section, sectionIndex) => {
      let subjectIndex = 0;
      
      for(let dayIndex = 0; dayIndex < days.length; dayIndex++) {
        for(let periodIndex = 0; periodIndex < timeSlots.length; periodIndex++) {
          const timeSlot = timeSlots[periodIndex];
          
          if(timeSlot.type === 'break') {
            grids[sectionIndex][dayIndex][periodIndex] = {
              name: timeSlot.label,
              type: 'break'
            };
            continue;
          }
          
          const subject = subs[subjectIndex % subs.length];
          grids[sectionIndex][dayIndex][periodIndex] = {
            name: subject.name,
            code: subject.code || subject.name.substring(0, 3).toUpperCase(),
            teachers: subject.teachers || 'TBD'
          };
          
          subjectIndex++;
        }
      }
    });

    initTablesWithTimeSlots(byId('tables'), sections, days, timeSlots);
    const tables = byId('tables').querySelectorAll('table');
    
    tables.forEach((table, sectionIndex) => {
      const tbody = table.querySelector('tbody');
      [...tbody.rows].forEach((row, dayIndex) => {
        [...row.cells].forEach((cell, cellIndex) => {
          if(cellIndex === 0) return;
          
          const periodIndex = cellIndex - 1;
          const cellData = grids[sectionIndex][dayIndex][periodIndex];
          
          if(cellData) {
            if(cellData.type === 'break') {
              cell.innerHTML = '';
              cell.style.background = '#f0f0f0';
            } else {
              cell.innerHTML = escapeHtml(cellData.code || cellData.name);
              cell.style.background = '#fff';
              cell.style.color = '#000';
              cell.style.fontWeight = 'bold';
            }
          }
        });
      });
    });

    buildLegend(subs);
    byId('status').textContent = '';
  }

  function initTablesWithTimeSlots(container, sections, days, timeSlots){
    container.innerHTML = '';
    sections.forEach(sec=>{
      // Create complete timetable structure matching the image
      const timetableDiv = document.createElement('div');
      timetableDiv.style.background = '#fff';
      timetableDiv.style.margin = '20px 0';
      timetableDiv.style.border = '2px solid #000';
      timetableDiv.style.fontFamily = 'Arial, sans-serif';
      
      timetableDiv.innerHTML = `
        <div style="text-align:center;padding:15px;border-bottom:2px solid #000">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMjgiIHN0cm9rZT0iIzAwNDA4NSIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjMwIiB5PSIyNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzAwNDA4NSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TUlUPC90ZXh0Pgo8dGV4dCB4PSIzMCIgeT0iNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI4IiBmaWxsPSIjMDA0MDg1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5NWVNPU0U8L3RleHQ+Cjwvc3ZnPgo=" style="width:60px;height:60px">
            <div style="flex:1;text-align:center">
              <h2 style="margin:0;font-size:18px;font-weight:bold;color:#000">MAHARAJA INSTITUTE OF TECHNOLOGY, MYSORE</h2>
              <p style="margin:2px 0;font-size:12px;color:#000">BELAWADI, SRIRANGAPATNA TALUK, MANDYA-571477</p>
              <p style="margin:2px 0;font-size:14px;font-weight:bold;color:#000">DEPARTMENT OF INFORMATION SCIENCE AND ENGINEERING</p>
            </div>
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMjgiIHN0cm9rZT0iIzAwNDA4NSIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjMwIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEwIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzAwNDA4NSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VlRVPC90ZXh0Pgo8L3N2Zz4K" style="width:60px;height:60px">
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:10px;padding:5px 0;border-top:1px solid #000">
            <span style="font-weight:bold;font-size:14px">Class: ${sec}</span>
            <span style="font-weight:bold;font-size:14px">Room Number: ___________</span>
          </div>
        </div>
      `;
      
      const table = document.createElement('table');
      table.dataset.section = sec;
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.background = '#fff';
      
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const htr = document.createElement('tr');
      const corner = document.createElement('th'); 
      corner.textContent = 'Day/Period';
      corner.style.border = '1px solid #000';
      corner.style.padding = '10px 8px';
      corner.style.background = '#e8e8e8';
      corner.style.fontWeight = 'bold';
      corner.style.fontSize = '12px';
      htr.appendChild(corner);
      
      timeSlots.forEach(slot=>{ 
        const th = document.createElement('th'); 
        if(slot.type === 'break') {
          th.innerHTML = slot.label.includes('LUNCH') ? 'LUNCH BREAK' : 'SHORT BREAK';
          th.style.writingMode = 'vertical-rl';
          th.style.textOrientation = 'mixed';
        } else {
          th.innerHTML = slot.label.replace(' to ', '<br>to<br>');
        }
        th.style.border = '1px solid #000';
        th.style.padding = '8px 4px';
        th.style.background = '#e8e8e8';
        th.style.fontSize = '10px';
        th.style.textAlign = 'center';
        th.style.fontWeight = 'bold';
        htr.appendChild(th); 
      });
      thead.appendChild(htr);

      days.forEach(d=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th'); 
        th.textContent = d.toUpperCase(); 
        th.style.border = '1px solid #000';
        th.style.padding = '15px 8px';
        th.style.background = '#e8e8e8';
        th.style.textAlign = 'center';
        th.style.fontWeight = 'bold';
        th.style.fontSize = '12px';
        tr.appendChild(th);
        
        for(let i = 0; i < timeSlots.length; i++){ 
          const td = document.createElement('td'); 
          td.dataset.empty = '1';
          td.style.border = '1px solid #000';
          td.style.padding = '15px 8px';
          td.style.height = '50px';
          td.style.textAlign = 'center';
          td.style.verticalAlign = 'middle';
          td.style.fontSize = '12px';
          td.style.fontWeight = 'bold';
          if(timeSlots[i].type === 'break') {
            td.style.background = '#f0f0f0';
          }
          tr.appendChild(td); 
        }
        tbody.appendChild(tr);
      });

      table.appendChild(thead); 
      table.appendChild(tbody);
      timetableDiv.appendChild(table);
      container.appendChild(timetableDiv);
    });
  }

  function generateTimetable(){
    const { days, periodCount, periodLabels, sections, lunchIndex, subs } = getSetup();

    if(!days.length || !subs.length || !sections.length) return;

    // Generate time slots from the schedule configuration
    const timeSlots = generateActualTimeSlots();
    
    // Create grids for each section
    const grids = sections.map(() => Array.from({length: days.length}, () => Array(timeSlots.length).fill(null)));
    
    // Distribute subjects across all sections
    sections.forEach((section, sectionIndex) => {
      let subjectIndex = 0;
      
      for(let dayIndex = 0; dayIndex < days.length; dayIndex++) {
        for(let periodIndex = 0; periodIndex < timeSlots.length; periodIndex++) {
          const timeSlot = timeSlots[periodIndex];
          
          // Handle breaks
          if(timeSlot.type === 'break') {
            grids[sectionIndex][dayIndex][periodIndex] = {
              name: timeSlot.label,
              type: 'break',
              color: timeSlot.label.includes('LUNCH') ? '#28a745' : '#17a2b8',
              teachers: ''
            };
            continue;
          }
          
          // Get current subject
          const subject = subs[subjectIndex % subs.length];
          
          // Handle lab subjects (2 consecutive periods)
          if(subject.type === 'lab' && periodIndex < timeSlots.length - 1 && timeSlots[periodIndex + 1].type !== 'break') {
            const teacherName = subject.teachers && subject.teachers.trim() ? subject.teachers.trim() : 'TBD';
            grids[sectionIndex][dayIndex][periodIndex] = {
              name: subject.name,
              code: subject.code || subject.name.substring(0, 3).toUpperCase(),
              type: subject.type,
              color: subject.color,
              teachers: teacherName
            };
            
            if(timeSlots[periodIndex + 1].type !== 'break') {
              grids[sectionIndex][dayIndex][periodIndex + 1] = {
                name: subject.name + ' Lab',
                code: subject.code || subject.name.substring(0, 3).toUpperCase(),
                type: subject.type,
                color: subject.color,
                teachers: teacherName
              };
              periodIndex++; // Skip next period as it's used for lab
            }
          } else if(subject.type !== 'lab') {
            // Place regular subject
            grids[sectionIndex][dayIndex][periodIndex] = {
              name: subject.name,
              code: subject.code || subject.name.substring(0, 3).toUpperCase(),
              type: subject.type,
              color: subject.color,
              teachers: subject.teachers && subject.teachers.trim() ? subject.teachers.trim() : 'TBD'
            };
          }
          
          subjectIndex++;
        }
      }
    });

    // Create and populate tables with time slots
    initTablesWithTimeSlots(byId('tables'), sections, days, timeSlots);
    const tables = byId('tables').querySelectorAll('table');
    
    tables.forEach((table, sectionIndex) => {
      const tbody = table.querySelector('tbody');
      [...tbody.rows].forEach((row, dayIndex) => {
        [...row.cells].forEach((cell, cellIndex) => {
          if(cellIndex === 0) return; // Skip day header
          
          const periodIndex = cellIndex - 1;
          const cellData = grids[sectionIndex][dayIndex][periodIndex];
          
          if(cellData) {
            cell.dataset.empty = '0';
            
            if(cellData.type === 'break') {
              cell.innerHTML = `<div style="font-weight:600;text-align:center;font-size:12px">${cellData.name}</div>`;
              cell.style.background = cellData.color;
              cell.style.color = '#fff';
            } else {
              cell.innerHTML = `<div style="font-weight:700;font-size:14px;margin-bottom:2px">${escapeHtml(cellData.code || cellData.name)}</div>`;
              cell.style.background = '#fff';
              cell.style.color = '#000';
              cell.style.border = '1px solid #000';
              cell.style.textAlign = 'center';
              cell.style.cursor = 'pointer';
              cell.addEventListener('click', onCellClick);
            }
          } else {
            cell.textContent = '';
            cell.dataset.empty = '1';
            cell.style.background = '#fff';
            cell.style.border = '1px solid #000';
          }
        });
      });
    });

    buildLegend(subs);
    byId('status').textContent = '';
  }

  // Modal system
  const modalBackdrop = byId('modalBackdrop');
  const modalContent = byId('modalContent');
  const modalCancel = byId('modalCancel');
  const modalSave = byId('modalSave');
  let modalSaveHandler = null;

  function showModal(html, onSave){
    modalContent.innerHTML = html;
    modalBackdrop.style.display = 'flex';
    modalSaveHandler = onSave;
  }
  function hideModal(){
    modalBackdrop.style.display = 'none';
    modalSaveHandler = null;
  }

  modalCancel.addEventListener('click', hideModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target === modalBackdrop) hideModal(); });
  modalSave.addEventListener('click', ()=>{
    if(typeof modalSaveHandler === 'function') modalSaveHandler();
    hideModal();
  });

  // Cell editing
  let lastClickedCell = null;
  function onCellClick(e){
    const td = e.currentTarget;
    lastClickedCell = td;
    const currentName = td.querySelector('div') ? td.querySelector('div').textContent : '';
    const teacherLine = td.querySelector('div:last-child') ? td.querySelector('div:last-child').textContent : '';
    let teacher = '', room = '';
    if(teacherLine.includes('‚Ä¢')){
      const parts = teacherLine.split('‚Ä¢').map(s=>s.trim());
      teacher = parts[0] || '';
      room = parts[1] || '';
    } else {
      teacher = teacherLine;
    }
    const colorStyle = td.style.background || '#6366f1';

    const html = `
      <h3>Edit Cell</h3>
      <div class="edit-row">
        <label>Subject</label>
        <input id="editSubject" value="${escapeHtml(currentName)}"/>
      </div>
      <div class="edit-row">
        <label>Teacher</label>
        <input id="editTeacher" value="${escapeHtml(teacher)}"/>
      </div>
      <div class="edit-row">
        <label>Room</label>
        <input id="editRoom" value="${escapeHtml(room)}"/>
      </div>
      <div class="edit-row">
        <label>Color</label>
        <input id="editColor" type="color" value="${toHexColor(colorStyle)}"/>
      </div>
    `;
    showModal(html, ()=>{
      const newName = byId('editSubject').value.trim();
      const newTeacher = byId('editTeacher').value.trim();
      const newRoom = byId('editRoom').value.trim();
      const newColor = byId('editColor').value;
      
      lastClickedCell.innerHTML = `<div style="font-weight:600;margin-bottom:2px">${escapeHtml(newName)}</div>
        <div style="font-size:11px;color:#94a3b8">${escapeHtml(newTeacher||'')}${newRoom?` ‚Ä¢ ${escapeHtml(newRoom)}`:''}</div>`;
      lastClickedCell.style.background = newColor;
    });
  }

  // Event listeners
  byId('viewDatabase').addEventListener('click', ()=>{
    window.open('subject.htm?from=timetable', '_blank');
  });

  byId('generate').addEventListener('click', () => {
    console.log('Generate button clicked');
    if(!selectedSubjectsData.length) {
      alert('Please select subjects first!');
      return;
    }
    window.open('enhanced-timetable.htm', '_blank');
  });
  byId('clear').addEventListener('click', ()=>{
    selectedSubjectsData = [];
    displaySelectedSubjects();
    byId('tables').innerHTML = '';
    byId('legend').innerHTML = '';
    byId('status').textContent = 'Ready to generate...';
  });

  // Listen for messages from subject database
  window.addEventListener('message', (event) => {
    if(event.data.type === 'SUBJECTS_SELECTED'){
      selectedSubjectsData = event.data.subjects.map((s, index) => ({
        name: s.name || s,
        credits: s.credits || 1,
        hours: s.hours || s.credits || 1,
        type: s.type || 'theory',
        teachers: s.teachers || '', // Preserve existing teacher assignment
        color: s.color || toHexColor(),
        order: index + 1
      }));
      displaySelectedSubjects();
      
      byId('status').textContent = '';
    }
  });

  byId('downloadCSV').addEventListener('click', ()=>{
    const tables = byId('tables').querySelectorAll('table');
    if(!tables.length){ alert('Generate timetable first!'); return; }
    const out = [];
    tables.forEach(tbl=>{
      out.push(`Section ${tbl.dataset.section}`);
      const heads = [...tbl.querySelectorAll('thead th')].map(th=>th.textContent);
      out.push(heads.join(','));
      [...tbl.querySelectorAll('tbody tr')].forEach(tr=>{
        const row = [...tr.cells].map(cell => `"${cell.innerText.replace(/"/g,'""')}"`);
        out.push(row.join(','));
      });
      out.push('');
    });
    const blob = new Blob([out.join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = 'timetable.csv'; 
    a.click();
    URL.revokeObjectURL(url);
  });

  byId('printBtn').addEventListener('click', ()=>{
    if(!byId('tables').innerHTML.trim()){ alert('Generate timetable first!'); return; }
    window.print();
  });

  byId('conflictsBtn').addEventListener('click', ()=>{
    const tables = byId('tables').querySelectorAll('table');
    if(!tables.length){ alert('Generate timetable first!'); return; }
    
    const conflicts = [];
    const teacherSchedule = {};
    
    tables.forEach((table, sectionIndex) => {
      const sectionName = table.dataset.section;
      const tbody = table.querySelector('tbody');
      
      [...tbody.rows].forEach((row, dayIndex) => {
        const dayName = row.cells[0].textContent;
        
        [...row.cells].forEach((cell, cellIndex) => {
          if(cellIndex === 0) return;
          
          const periodIndex = cellIndex - 1;
          const cellText = cell.textContent.trim();
          
          if(cellText && cellText !== 'Free' && !cellText.includes('LUNCH')) {
            const lines = cellText.split('\n');
            const subject = lines[0];
            const teacher = lines[1] || 'TBD';
            
            if(teacher !== 'TBD' && teacher !== '') {
              const timeSlot = `${dayName}-Period${periodIndex + 1}`;
              
              if(!teacherSchedule[teacher]) {
                teacherSchedule[teacher] = [];
              }
              
              const existing = teacherSchedule[teacher].find(slot => slot.timeSlot === timeSlot);
              if(existing) {
                conflicts.push(`‚ö†Ô∏è ${teacher} has conflict at ${timeSlot}: Section ${existing.section} (${existing.subject}) vs Section ${sectionName} (${subject})`);
              } else {
                teacherSchedule[teacher].push({ timeSlot, section: sectionName, subject });
              }
            }
          }
        });
      });
    });
    
    if(conflicts.length === 0) {
      byId('status').innerHTML = `<div style="color:var(--success);font-weight:600">‚úÖ No scheduling conflicts found!</div>`;
    } else {
      const conflictList = conflicts.map(c => `<li style="margin:4px 0;padding:8px;background:rgba(220,53,69,0.1);border-left:3px solid #dc3545;border-radius:4px">${c}</li>`).join('');
      showModal(`<h3>‚ö†Ô∏è Scheduling Conflicts (${conflicts.length})</h3><ul style="list-style:none;padding:0;max-height:300px;overflow-y:auto">${conflictList}</ul>`, null);
    }
  });

  // Config save/load
  byId('saveConfig').addEventListener('click', ()=>{
    const config = {
      days: byId('days').value,
      periodCount: byId('periodCount').value,
      periodLabels: byId('periodLabels').value,
      sections: byId('sections').value,
      lunchIndex: byId('lunchIndex').value,
      subjects: selectedSubjectsData
    };
    localStorage.setItem('timetable_config', JSON.stringify(config));
    byId('status').textContent = 'üíæ Configuration saved!';
  });

  byId('loadConfig').addEventListener('click', ()=>{
    const raw = localStorage.getItem('timetable_config');
    if(!raw){ alert('No saved config found!'); return; }
    const cfg = JSON.parse(raw);
    byId('days').value = cfg.days || '';
    byId('periodCount').value = cfg.periodCount || 6;
    byId('periodLabels').value = cfg.periodLabels || '';
    byId('sections').value = cfg.sections || '';
    byId('lunchIndex').value = cfg.lunchIndex || 3;
    selectedSubjectsData = cfg.subjects || [];
    displaySelectedSubjects();
    byId('status').textContent = 'üìÅ Configuration loaded!';
  });

  // Generate time slots button handler
  const generateBtn = document.querySelector('button[onclick="generateTimeSlots()"]');
  if(generateBtn) {
    generateBtn.removeAttribute('onclick');
    generateBtn.addEventListener('click', generateTimeSlots);
  }

  // Simple time generator with custom breaks
  function generateTimeSlots(){
    const periodCount = parseInt(byId('periodCount').value) || 6;
    const lunchIndex = parseInt(byId('lunchIndex').value) || 3;
    const startTime = byId('startTime').value.trim() || '9';
    const endTime = byId('endTime').value.trim() || '4';
    const shortBreak = byId('shortBreak').value.trim() || '11-11.15';
    const lunchBreak = byId('lunchBreak').value.trim() || '1.15-2';
    
    try {
      let startHour = parseFloat(startTime);
      let endHour = parseFloat(endTime);
      
      if(isNaN(startHour) || isNaN(endHour)) throw new Error('Invalid time format');
      
      // Convert to 24-hour format for proper comparison
      // If end time is smaller than start time, assume it's PM
      if(endHour <= startHour && endHour <= 12) {
        endHour += 12; // Convert to PM
      }
      
      if(startHour >= endHour) throw new Error('End time must be after start time');
      
      // Parse break times (handle decimal format like 11.15 = 11:15)
      const breakPeriods = [];
      if(shortBreak) {
        const [startStr, endStr] = shortBreak.split('-').map(t => t.trim());
        const start = parseFloat(startStr);
        const end = parseFloat(endStr);
        if(!isNaN(start) && !isNaN(end)) {
          breakPeriods.push({ start, end, duration: (end - start) * 60, label: 'Short Break' });
        }
      }
      if(lunchBreak) {
        const [startStr, endStr] = lunchBreak.split('-').map(t => t.trim());
        let start = parseFloat(startStr);
        let end = parseFloat(endStr);
        // Convert PM times if needed
        if(start < 12 && start >= 1) start += 12;
        if(end < 12 && end >= 1) end += 12;
        if(!isNaN(start) && !isNaN(end)) {
          breakPeriods.push({ start, end, duration: (end - start) * 60, label: 'Lunch Break' });
        }
      }
      
      const slots = [];
      let currentHour = startHour;
      const periodIcons = ['üìö', '‚úèÔ∏è', 'üî¨', 'üìñ', 'üéØ', 'üí°', 'üåü', '‚ö°'];
      
      let periodNum = 1;
      
      while(periodNum <= periodCount && currentHour < endHour){
        // Check if current time hits a break
        let breakFound = false;
        for(const breakPeriod of breakPeriods){
          if(Math.abs(currentHour - breakPeriod.start) < 0.01){
            // Insert break
            const icon = breakPeriod.label.includes('Lunch') ? 'üçΩÔ∏è' : '‚òï';
            slots.push(`${icon} ${breakPeriod.label}: ${formatTime(breakPeriod.start)} - ${formatTime(breakPeriod.end)}`);
            currentHour = breakPeriod.end;
            breakFound = true;
            break;
          }
        }
        
        if(!breakFound && currentHour < endHour){
          // Add regular period
          const start = formatTime(currentHour);
          const nextHour = currentHour + 1;
          const end = formatTime(nextHour);
          const icon = periodIcons[periodNum-1] || 'üìù';
          
          slots.push(`${icon} Period ${periodNum}: ${start} - ${end}`);
          currentHour = nextHour;
          periodNum++;
        }
      }
      
      // Create smart preview
      const preview = slots.map(slot => {
        if(slot.includes('Period')){
          return `<div style="padding:4px 8px;margin:2px 0;background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(139,92,246,0.1));border-left:3px solid #6366f1;border-radius:4px;font-size:12px">${slot}</div>`;
        } else {
          return `<div style="padding:4px 8px;margin:2px 0;background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(16,185,129,0.1));border-left:3px solid #22c55e;border-radius:4px;font-size:12px;color:#059669">${slot}</div>`;
        }
      }).join('');
      
      byId('periodLabels').innerHTML = preview || 'Click Generate Schedule to see timing preview...';
      byId('periodLabels').style.height = 'auto';
      byId('periodLabels').style.minHeight = '120px';
      
      // Success feedback
      const btn = byId('generateBtn') || document.querySelector('button[onclick="generateTimeSlots()"]');
      if(btn) {
        btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
        btn.textContent = '‚úÖ';
        setTimeout(() => {
          btn.style.background = 'linear-gradient(135deg,var(--info) 0%,#138496 100%)';
          btn.textContent = '‚ö°';
        }, 1500);
      }
      
    } catch(error) {
      byId('periodLabels').value = `‚ùå Error: ${error.message}\n\nEnter start time, end time, and break times`;
      
      const btn = byId('generateBtn') || document.querySelector('button[onclick="generateTimeSlots()"]');
      if(btn) {
        btn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
        btn.textContent = '‚ùå';
        setTimeout(() => {
          btn.style.background = 'linear-gradient(135deg,var(--info) 0%,#138496 100%)';
          btn.textContent = '‚ö°';
        }, 2000);
      }
    }
  }
  
  function formatTime(hour){
    const h = Math.floor(hour);
    const decimal = hour - h;
    // Convert decimal to minutes: 0.15 = 15 minutes, 0.25 = 15 minutes, etc.
    let m;
    if(decimal === 0.15) m = 15;
    else if(decimal === 0.25) m = 15; 
    else if(decimal === 0.45) m = 45;
    else m = Math.round(decimal * 100); // For cases like 1.15 -> 15 minutes
    
    const period = h >= 12 ? 'PM' : 'AM';
    let displayHour = h > 12 ? h - 12 : (h === 0 ? 12 : h);
    if(h === 12) displayHour = 12;
    const minutes = m > 0 ? `:${m.toString().padStart(2,'0')}` : ':00';
    return `${displayHour}${minutes} ${period}`;
  }

  // Days dropdown handler
  byId('days').addEventListener('change', (e) => {
    // Auto-adjust lunch period based on day count
    const dayCount = e.target.value.split(',').length;
    if(dayCount >= 6) {
      byId('lunchIndex').value = 4; // Later lunch for 6-day week
    } else {
      byId('lunchIndex').value = 3; // Standard lunch for 5-day week
    }
    generateTimeSlots(); // Auto-regenerate timings
  });

  // Auto-generate breaks based on standard rules
  function autoGenerateBreaks() {
    const startTime = parseFloat(byId('startTime').value) || 9;
    const endTime = parseFloat(byId('endTime').value) || 4;
    
    if(startTime && endTime) {
      // Fixed rules: 15-minute break at 11:00-11:15, 45-minute lunch at 1:15-2:00
      byId('shortBreak').value = '11-11.15';
      byId('lunchBreak').value = '1.15-2';
      
      generateTimeSlots();
    }
  }
  
  // Auto-generate timings when inputs change with enhanced feedback
  ['periodCount', 'shortBreak', 'lunchBreak', 'lunchIndex'].forEach(id => {
    const input = byId(id);
    input.addEventListener('change', generateTimeSlots);
    input.addEventListener('input', () => {
      input.style.borderColor = 'rgba(99,102,241,0.5)';
      input.style.boxShadow = '0 0 0 3px rgba(99,102,241,0.1)';
      setTimeout(() => {
        input.style.borderColor = '';
        input.style.boxShadow = '';
      }, 1000);
    });
  });
  
  // Auto-generate breaks when start/end time changes
  ['startTime', 'endTime'].forEach(id => {
    const input = byId(id);
    input.addEventListener('change', autoGenerateBreaks);
    input.addEventListener('input', () => {
      input.style.borderColor = 'rgba(99,102,241,0.5)';
      input.style.boxShadow = '0 0 0 3px rgba(99,102,241,0.1)';
      setTimeout(() => {
        input.style.borderColor = '';
        input.style.boxShadow = '';
      }, 1000);
    });
  });

  // Initialize
  displaySelectedSubjects();

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
      e.preventDefault();
      byId('saveConfig').click();
    }
    if(e.key === 'Escape') hideModal();
  });
</script>
</body>
</html>