<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subject Database</title>
<style>
:root {
  --primary: #004085;
  --danger: #dc3545;
  --light-grey: #f8f9fa;
  --info: #17a2b8;
  --medium-blue: #0069d9;
  --success: #28a745;
  --warning: #ffc107;
}
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, rgba(248,249,250,0.95) 0%, rgba(233,236,239,0.9) 100%);
  color: var(--primary);
  height: 100vh;
  overflow: hidden;
}
.header {
  display: flex;
  align-items: center;
  justify-content: space-between; 
  padding: 5px 20px;
  background: linear-gradient(135deg, #004085 0%, #003366 50%, #004085 100%);
  border-bottom: 2px solid #002244;
  flex-wrap: wrap;
  backdrop-filter: blur(20px);
  box-shadow: 0 3px 15px rgba(0, 64, 133, 0.4);
}
.logo-left, .logo-right {
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  text-align: center;
}
.logo-left img, .logo-right img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.3);
}
.header-text {
  text-align: center;
  flex: 1;
  min-width: 280px;
}
.header-text h1 {
  margin: 2px 0;
  font-weight: bold;
  font-size: 16px;
  line-height: 1.2;
}
.header-text h1:nth-child(2) {
  font-size: 20px;
  margin: 3px 0;
}
.green { color: white; }
.orange { color: white; }

main {
  display: flex;
  height: calc(100vh - 84px);
  overflow: hidden;
}
aside {
  width: 280px;
  background: #e9ecef;
  padding: 25px 15px 15px 15px;
  overflow-y: auto;
  flex-shrink: 0;
  position: relative;
}
aside label {
  font-weight: bold;
  margin-bottom: 5px;
  display: block;
  color: var(--primary);
  font-size: 16px;
}
aside select, aside input {
  width: 100%;
  height: 40px;
  padding: 8px;
  font-size: 14px;
  border-radius: 20px;
  border: 1px solid var(--primary);
  margin-bottom: 8px;
  color: var(--primary);
  box-sizing: border-box;
}
aside button {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 6px;
  color: white;
}
#addBtn { background: var(--info); }
#saveBtn { background: var(--success); }
#viewDbBtn { background: var(--medium-blue); }
#clearBtn { background: var(--danger); }

.stats-box {
  background: white;
  padding: 10px;
  border-radius: 8px;
  margin: 10px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.stats-box h4 {
  margin: 0 0 10px 0;
  color: var(--primary);
}
.stat-item {
  display: flex;
  justify-content: space-between;
  margin: 5px 0;
  font-size: 16px;
}

section {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
  height: 100%;
  display: flex;
  flex-direction: column;
}
.table-container {
  flex: 1;
  overflow-y: auto;
  max-height: calc(100vh - 300px);
  border: 1px solid rgba(0,64,133,0.2);
  border-radius: 8px;
  background: white;
}
section h2 {
  font-size: 20px;
  color: var(--primary);
  margin-bottom: 10px;
}

#subjectsTable {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 6px;
  margin: 0;
}
#subjectsTable thead {
  position: sticky;
  top: 0;
  z-index: 10;
  background: white;
}
#subjectsTable thead tr {
  background: var(--light-grey);
}
#subjectsTable th, #subjectsTable td {
  text-align: left;
  padding: 8px;
  font-size: 14px;
  color: var(--primary);
}
#subjectsTable tbody tr {
  background: white;
  box-shadow: 0 2px 4px rgba(0,64,133,0.1);
  border-radius: 8px;
}
.actions button {
  margin-right: 6px;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  border: none;
  cursor: pointer;
}
.editBtn { background: var(--info); color: white; }
.delBtn { background: var(--danger); color: white; }

.bulk-actions {
  margin: 10px 0;
  padding: 10px;
  background: white;
  border-radius: 6px;
}
.bulk-actions button {
  margin-right: 10px;
  padding: 8px 14px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

#dbOverlay {
  display: none;
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: var(--light-grey);
  overflow-y: auto;
  z-index: 1000;
  padding: 20px;
}
#dbBox {
  width: 100%;
  height: 100%;
  padding: 20px;
  color: var(--primary);
}
#dbBox h2 {
  margin-top: 0;
  text-align: center;
  color: var(--primary);
}
#dbClose {
  background: var(--danger);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  float: right;
  margin-bottom: 10px;
}
#goToTimetable {
  background: var(--success);
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 10px;
}

#dbContent {
  max-width: 1200px;
  margin: 0;
  padding: 20px;
  text-align: left;
}

.year-folder {
  margin-bottom: 30px;
  border: 2px solid var(--primary);
  border-radius: 15px;
  background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
  box-shadow: 0 8px 25px rgba(0,64,133,0.12), 0 4px 12px rgba(0,0,0,0.05);
  overflow: hidden;
  transition: all 0.3s ease;
}

.year-folder:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 35px rgba(0,64,133,0.18), 0 6px 15px rgba(0,0,0,0.08);
}

.folder-header {
  background: linear-gradient(135deg, var(--primary) 0%, #0056b3 50%, #003d82 100%);
  color: white;
  padding: 20px 25px;
  cursor: pointer;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 18px;
  letter-spacing: 0.5px;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.folder-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s ease;
}

.folder-header:hover::before {
  left: 100%;
}

.folder-header::after {
  content: '‚ñº';
  font-size: 14px;
  transition: transform 0.3s ease;
}

.folder-header.collapsed::after {
  transform: rotate(-90deg);
}

.folder-stats {
  font-size: 14px;
  opacity: 0.9;
  font-weight: 400;
}

.folder-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  padding: 25px;
  background: linear-gradient(145deg, #fafbfc 0%, #f1f3f5 100%);
  align-items: start;
  justify-content: start;
}

.db-section {
  background: linear-gradient(145deg, #ffffff 0%, #f8fbff 50%, #ffffff 100%);
  padding: 0;
  border-radius: 8px;
  box-shadow: 0 3px 10px rgba(0,64,133,0.08), 0 1px 4px rgba(0,0,0,0.03);
  border: 1px solid rgba(0,64,133,0.12);
  transition: all 0.3s ease;
  overflow: hidden;
  min-height: 200px;
  display: flex;
  flex-direction: column;
}

.db-section:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(0,64,133,0.15), 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--primary);
}

.db-section h3 {
  font-size: 12px;
  margin: 0;
  color: white;
  background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%);
  padding: 8px 12px;
  text-align: center;
  font-weight: 600;
  letter-spacing: 0.2px;
  box-shadow: 0 1px 4px rgba(0,64,133,0.15);
  position: relative;
}

.db-section h3::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 2px;
  background: rgba(255,255,255,0.3);
  border-radius: 2px;
}

.table-wrapper {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  max-height: 120px;
}

.db-section table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 12px;
}

.db-section table th {
  background: linear-gradient(135deg, rgba(0,64,133,0.08) 0%, rgba(0,64,133,0.05) 100%);
  color: var(--primary);
  font-weight: 600;
  padding: 10px 8px;
  text-align: left;
  border-bottom: 2px solid rgba(0,64,133,0.1);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.db-section table td {
  padding: 8px;
  border-bottom: 1px solid rgba(0,64,133,0.05);
  color: var(--primary);
  font-size: 12px;
  vertical-align: middle;
}

.db-section table tr:hover {
  background: rgba(0,64,133,0.03);
}

.subject-name {
  font-weight: 500;
  color: var(--primary);
}

.credits-badge {
  background: linear-gradient(135deg, var(--info) 0%, #0056b3 100%);
  color: white;
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 600;
  text-align: center;
  min-width: 25px;
  display: inline-block;
}

.type-badge {
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  text-align: center;
}

.type-theory { background: #e3f2fd; color: #1565c0; }
.type-lab { background: #f3e5f5; color: #7b1fa2; }
.type-mcq { background: #e8f5e8; color: #2e7d32; }
.type-free { background: #fff3e0; color: #ef6c00; }

.db-actions {
  padding: 6px 8px;
  background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
  border-top: 1px solid rgba(0,64,133,0.1);
  display: flex;
  gap: 6px;
  margin-top: auto;
}

.db-actions button {
  flex: 1;
  padding: 6px 10px;
  font-size: 10px;
  font-weight: 600;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.2px;
}

.db-actions button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.useBtn { 
  background: linear-gradient(135deg, var(--primary) 0%, #0056b3 100%); 
  color: white; 
}

.delBtn { 
  background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%); 
  color: white; 
}

.semester-count {
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

#toast {
  position: fixed;
  bottom: 20px; right: 20px;
  background: var(--primary);
  color: white;
  padding: 10px 16px;
  border-radius: 6px;
  display: none;
  z-index: 2000;
}
</style>
</head>
<body>
  <div class="header">
    <div class="logo-left">
      <img src="left-logo.png" alt="MET Logo">
    </div>
    <div class="header-text">
      <h1 class="green">üéì Maharaja Education Trust (R), Mysuru</h1>
      <h1 class="orange">üèõÔ∏è Maharaja Institute of Technology, Mysore</h1>
      <h1 class="green">An Autonomous Institution Affiliated to VTU, Belagavi</h1>
      <h1 class="orange">‚úÖ Approved by AICTE, New Delhi | Recognized by Government of Karnataka</h1>
    </div>
    <div class="logo-right">
      <img src="right-logo.png" alt="Circle Logo">
    </div>
  </div>

<main>
  <aside>
    <button id="backBtn" style="position: absolute; top: 5px; left: 5px; background: white; color: var(--primary); border: 1px solid var(--primary); padding: 4px 8px; font-size: 14px; border-radius: 8px; z-index: 10; width: auto;">‚Üê Back</button>
    
    <label>Academic Year:</label>
    <input type="text" id="academicYearInput" placeholder="EG:2024-25">

    <label>Year:</label>
    <select id="yearSelect">
      <option value="">--Select--</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>

    <label>Semester:</label>
    <select id="semesterSelect">
      <option value="">--Select--</option>
    </select>

    <label>Subject Name:</label>
    <input type="text" id="subjectInput" placeholder="Enter subject">

    <label>Credits:</label>
    <input type="number" id="creditsInput" min="1" max="6" value="1" placeholder="Credits">

    <label>Type:</label>
    <select id="typeInput">
      <option value="theory">Theory</option>
      <option value="lab">Lab (2 consecutive hours)</option>
      <option value="mcq">MCQ</option>
      <option value="free">Free</option>
    </select>

    <button id="addBtn">Add Subject</button>
    <button id="saveBtn">üíæ Save Database</button>
    <button id="viewDbBtn">üìÇ View Database</button>
    <button id="clearBtn">üóëÔ∏è Clear All</button>

    <div class="stats-box">
      <h4>Statistics</h4>
      <div class="stat-item">
        <span>Academic Years:</span>
        <span id="totalYears">0</span>
      </div>
      <div class="stat-item">
        <span>Total Subjects:</span>
        <span id="totalSubjects">0</span>
      </div>
      <div class="stat-item">
        <span>Current:</span>
        <span id="currentSubjects">0</span>
      </div>
    </div>
  </aside>
  
  <section>
    <h2>Subjects List</h2>
    
    <div class="bulk-actions">
      <button id="selectAllBtn" style="background: var(--info); color: white;">Select All</button>
      <button id="clearSelectionBtn" style="background: var(--warning); color: var(--primary);">Clear Selection</button>
      <button id="deleteSelectedBtn" style="background: var(--danger); color: white;">Delete Selected</button>
      <span id="selectedCount">0 selected</span>
    </div>

    <div class="table-container">
      <table id="subjectsTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="masterCheckbox"></th>
            <th>Subject</th>
            <th>Credits</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<div id="dbOverlay">
  <div id="dbBox">
    <button id="dbClose">Close</button>
    <button id="goToTimetable">üéì Go to Timetable Generator</button>
    <h2>üìÇ Stored Database</h2>
    <div id="dbContent"></div>
  </div>
</div>

<div id="toast"></div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const currentDepartment = urlParams.get('dept') || localStorage.getItem('currentDepartment') || 'ISE';
const storageKey = `subjectsData_${currentDepartment}`;

let subjectsData = JSON.parse(localStorage.getItem(storageKey)||'{}');
let currentAcademicYear = '', currentYear = '', currentSemester = '', currentSubjects = [];
let selectedSubjects = new Set();

// DOM elements
const academicYearInput = document.getElementById('academicYearInput');
const yearSelect = document.getElementById('yearSelect');
const semesterSelect = document.getElementById('semesterSelect');
const subjectInput = document.getElementById('subjectInput');
const addBtn = document.getElementById('addBtn');
const saveBtn = document.getElementById('saveBtn');
const viewDbBtn = document.getElementById('viewDbBtn');
const clearBtn = document.getElementById('clearBtn');
const selectAllBtn = document.getElementById('selectAllBtn');
const clearSelectionBtn = document.getElementById('clearSelectionBtn');
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
const masterCheckbox = document.getElementById('masterCheckbox');
const subjectsTable = document.querySelector('#subjectsTable tbody');
const dbOverlay = document.getElementById('dbOverlay');
const dbClose = document.getElementById('dbClose');
const dbContent = document.getElementById('dbContent');
const toast = document.getElementById('toast');
const backBtn = document.getElementById('backBtn');

// Back button
backBtn.onclick = () => window.location.href = 'page.htm';

// Update statistics
function updateStats(){
  const totalYears = Object.keys(subjectsData).length;
  let totalSubjects = 0;
  
  for(const ay in subjectsData){
    for(const y in subjectsData[ay]){
      for(const s in subjectsData[ay][y]){
        totalSubjects += subjectsData[ay][y][s].length;
      }
    }
  }
  
  document.getElementById('totalYears').textContent = totalYears;
  document.getElementById('totalSubjects').textContent = totalSubjects;
  document.getElementById('currentSubjects').textContent = currentSubjects.length;
}

// Year selection handler
yearSelect.onchange = () => {
  currentYear = yearSelect.value;
  const semesterOptions = { '1':['1','2'], '2':['3','4'], '3':['5','6'], '4':['7','8'] };
  semesterSelect.innerHTML = '<option value="">--Select--</option>';
  if(semesterOptions[currentYear]){
    semesterOptions[currentYear].forEach(sem=>{
      const option = document.createElement('option');
      option.value = sem;
      option.textContent = sem;
      semesterSelect.appendChild(option);
    });
  }
  currentSemester = '';
  currentSubjects = [];
  renderTable();
  updateStats();
};

// Semester selection handler
semesterSelect.onchange = () => {
  currentSemester = semesterSelect.value;
  currentAcademicYear = academicYearInput.value.trim();
  if(currentAcademicYear && currentYear && currentSemester &&
     subjectsData[currentAcademicYear] &&
     subjectsData[currentAcademicYear][currentYear] &&
     subjectsData[currentAcademicYear][currentYear][currentSemester]){
    currentSubjects = subjectsData[currentAcademicYear][currentYear][currentSemester];
  } else currentSubjects = [];
  renderTable();
  updateStats();
};

// Render subjects table
function renderTable(){
  subjectsTable.innerHTML = '';
  selectedSubjects.clear();
  
  currentSubjects.forEach((sub,i)=>{
    const tr = document.createElement('tr');
    const name = typeof sub === 'object' ? escapeHtml(sub.name) : escapeHtml(sub);
    const credits = typeof sub === 'object' ? (sub.credits || 1) : 1;
    const type = typeof sub === 'object' ? (sub.type || 'theory') : 'theory';
    
    tr.innerHTML = `
      <td><input type="checkbox" class="subject-checkbox" data-i="${i}"></td>
      <td>${name}</td>
      <td>${credits}</td>
      <td><span style="background:var(--info);color:white;padding:2px 6px;border-radius:4px;font-size:11px;">${type}</span></td>
      <td class="actions">
        <button class="editBtn" data-i="${i}">Edit</button>
        <button class="delBtn" data-i="${i}">Delete</button>
      </td>
    `;
    subjectsTable.appendChild(tr);
  });
  attachRowEvents();
  updateSelectionCount();
}

// Attach event listeners
function attachRowEvents(){
  document.querySelectorAll('.editBtn').forEach(btn=>{
    btn.onclick=()=>{
      const i=btn.dataset.i;
      const subject = currentSubjects[i];
      const currentName = subject.name || subject;
      const currentCredits = subject.credits || 1;
      const currentType = subject.type || 'theory';
      
      const editForm = document.createElement('div');
      editForm.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;color:var(--primary)';
      editForm.innerHTML = `
        <h3 style="margin:0 0 15px;color:var(--primary)">Edit Subject</h3>
        <label style="display:block;margin:8px 0 4px;font-weight:bold">Subject Name:</label>
        <input id="editName" value="${escapeHtml(currentName)}" style="width:100%;padding:8px;border:1px solid var(--primary);border-radius:4px;margin-bottom:10px">
        <label style="display:block;margin:8px 0 4px;font-weight:bold">Credits:</label>
        <input id="editCredits" type="number" min="1" max="6" value="${currentCredits}" style="width:100%;padding:8px;border:1px solid var(--primary);border-radius:4px;margin-bottom:10px">
        <label style="display:block;margin:8px 0 4px;font-weight:bold">Type:</label>
        <select id="editType" style="width:100%;padding:8px;border:1px solid var(--primary);border-radius:4px;margin-bottom:15px">
          <option value="theory" ${currentType==='theory'?'selected':''}>Theory</option>
          <option value="lab" ${currentType==='lab'?'selected':''}>Lab (2 consecutive hours)</option>
          <option value="mcq" ${currentType==='mcq'?'selected':''}>MCQ</option>
          <option value="free" ${currentType==='free'?'selected':''}>Free</option>
        </select>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button id="cancelEdit" style="padding:8px 16px;background:var(--danger);color:white;border:none;border-radius:4px;cursor:pointer">Cancel</button>
          <button id="saveEdit" style="padding:8px 16px;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer">Save</button>
        </div>
      `;
      
      document.body.appendChild(editForm);
      
      document.getElementById('cancelEdit').onclick = () => document.body.removeChild(editForm);
      document.getElementById('saveEdit').onclick = () => {
        const newName = document.getElementById('editName').value.trim();
        const newCredits = parseInt(document.getElementById('editCredits').value) || 1;
        const newType = document.getElementById('editType').value;
        
        if(newName){
          currentSubjects[i] = {name: newName, credits: newCredits, type: newType};
          renderTable();
          autoSave(); // Auto-save after editing
          showToast("Subject updated and saved automatically","#28a745");
        }
        document.body.removeChild(editForm);
      };
    };
  });
  
  document.querySelectorAll('.delBtn').forEach(btn=>{
    btn.onclick=()=>{
      const i=btn.dataset.i;
      const subjectName = currentSubjects[i].name || currentSubjects[i];
      if(confirm(`Delete "${subjectName}" permanently?`)){
        currentSubjects.splice(i,1);
        renderTable();
        autoSave(); // Auto-save after deleting
        showToast("Subject deleted and saved automatically","#dc3545");
      }
    };
  });

  document.querySelectorAll('.subject-checkbox').forEach(checkbox=>{
    checkbox.onchange=()=>{
      const i = checkbox.dataset.i;
      if(checkbox.checked){
        selectedSubjects.add(i);
      } else {
        selectedSubjects.delete(i);
      }
      updateSelectionCount();
    };
  });
}

// Bulk operations
selectAllBtn.onclick = () => {
  document.querySelectorAll('.subject-checkbox').forEach(cb => {
    cb.checked = true;
    selectedSubjects.add(cb.dataset.i);
  });
  masterCheckbox.checked = true;
  updateSelectionCount();
};

clearSelectionBtn.onclick = () => {
  document.querySelectorAll('.subject-checkbox').forEach(cb => cb.checked = false);
  selectedSubjects.clear();
  masterCheckbox.checked = false;
  updateSelectionCount();
};

deleteSelectedBtn.onclick = () => {
  if(selectedSubjects.size === 0){
    showToast("No subjects selected","#dc3545");
    return;
  }
  if(confirm(`Delete ${selectedSubjects.size} selected subjects?`)){
    const indicesToDelete = Array.from(selectedSubjects).map(i => parseInt(i)).sort((a,b) => b-a);
    indicesToDelete.forEach(index => currentSubjects.splice(index, 1));
    renderTable();
    autoSave(); // Auto-save after bulk delete
    showToast(`${selectedSubjects.size} subjects deleted and saved automatically`,"#dc3545");
  }
};

masterCheckbox.onchange = () => {
  if(masterCheckbox.checked){
    selectAllBtn.click();
  } else {
    clearSelectionBtn.click();
  }
};

function updateSelectionCount(){
  document.getElementById('selectedCount').textContent = `${selectedSubjects.size} selected`;
}

// Add subject
addBtn.onclick=()=>{
  currentAcademicYear = academicYearInput.value.trim();
  if(!currentAcademicYear){ showToast("Enter Academic Year","#dc3545"); return; }
  if(!currentYear || !currentSemester){ showToast("Select Year & Semester","#dc3545"); return; }
  if(subjectInput.value.trim()===''){ showToast("Enter subject name","#dc3545"); return; }
  
  const subjectName = subjectInput.value.trim();
  const credits = parseInt(document.getElementById('creditsInput').value) || 1;
  const type = document.getElementById('typeInput').value;
  
  // Only check for duplicates within the SAME academic year, year, and semester
  const exists = currentSubjects.some(sub => {
    const name = sub.name || sub;
    return name.toLowerCase() === subjectName.toLowerCase();
  });
  
  if(exists){
    showToast("Subject already exists in this semester","#dc3545");
    return;
  }
  
  currentSubjects.push({name:subjectName, credits:credits, type:type});
  subjectInput.value='';
  document.getElementById('creditsInput').value='1';
  document.getElementById('typeInput').value='theory';
  renderTable();
  autoSave(); // Auto-save after adding
  updateStats();
  showToast("Subject added and saved automatically","#28a745");
};

// Auto-save function
function autoSave(){
  currentAcademicYear = academicYearInput.value.trim();
  if(currentAcademicYear && currentYear && currentSemester && currentSubjects.length > 0){
    if(!subjectsData[currentAcademicYear]) subjectsData[currentAcademicYear]={};
    if(!subjectsData[currentAcademicYear][currentYear]) subjectsData[currentAcademicYear][currentYear]={};
    subjectsData[currentAcademicYear][currentYear][currentSemester]=[...currentSubjects];
    localStorage.setItem(storageKey, JSON.stringify(subjectsData));
    updateStats();
  }
}

// Save database
saveBtn.onclick=()=>{
  currentAcademicYear = academicYearInput.value.trim();
  if(!currentAcademicYear){ showToast("Enter Academic Year","#dc3545"); return; }
  if(!currentYear || !currentSemester){ showToast("Select Year & Semester","#dc3545"); return; }
  if(currentSubjects.length === 0){ showToast("No subjects to save","#dc3545"); return; }
  
  autoSave();
  currentSubjects = [];
  renderTable();
  updateStats();
  showToast(`Database saved for ${currentDepartment}`,"#28a745");
};

// Clear all data
clearBtn.onclick = () => {
  if(confirm(`Clear all data for ${currentDepartment} permanently?`)){
    subjectsData = {};
    currentSubjects = [];
    localStorage.removeItem(storageKey);
    renderTable();
    updateStats();
    showToast(`All data cleared for ${currentDepartment}`,"#dc3545");
  }
};

// View Database
viewDbBtn.onclick = () => {
  dbContent.innerHTML='';
  
  if(Object.keys(subjectsData).length===0){
    dbContent.innerHTML=`
      <div style="text-align:center;padding:60px 20px;">
        <div style="font-size:48px;margin-bottom:20px;opacity:0.3;">üìö</div>
        <h3 style="color:var(--primary);margin-bottom:10px;">No Subjects Database Found</h3>
        <p style="color:#666;font-size:16px;margin-bottom:30px;">Start by adding subjects and saving them to build your database.</p>
        <div style="background:linear-gradient(135deg,#f8fafc 0%,#e9ecef 100%);padding:20px;border-radius:12px;border:2px dashed #ddd;">
          <p style="color:#888;font-size:14px;margin:0;">üí° Tip: Organize subjects by Academic Year ‚Üí Year ‚Üí Semester for easy management</p>
        </div>
      </div>
    `;
    dbOverlay.style.display='block';
    return;
  }
  
  for(const ay in subjectsData){
    const yearFolder = document.createElement('div');
    yearFolder.className = 'year-folder';
    
    const folderHeader = document.createElement('div');
    folderHeader.className = 'folder-header';
    folderHeader.innerHTML = `üìÇ ${ay}`;
    
    const folderContent = document.createElement('div');
    folderContent.className = 'folder-content';
    folderContent.style.display = 'none';
    
    // Count total subjects in this academic year
    let totalSubjectsInYear = 0;
    let totalSemesters = 0;
    for(const y in subjectsData[ay]){
      for(const s in subjectsData[ay][y]){
        if(subjectsData[ay][y][s] && subjectsData[ay][y][s].length > 0){
          totalSubjectsInYear += subjectsData[ay][y][s].length;
          totalSemesters++;
        }
      }
    }
    
    folderHeader.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 20px;">üìÇ</span>
        <span>${ay}</span>
      </div>
      <div class="folder-stats">
        <span class="semester-count">${totalSemesters} Semesters</span>
        <span class="semester-count" style="margin-left: 8px;">${totalSubjectsInYear} Subjects</span>
      </div>
    `;
    
    folderHeader.classList.add('collapsed');
    folderHeader.onclick = function(){
      const isCollapsed = folderContent.style.display === 'none';
      if(isCollapsed){
        folderContent.style.display = 'grid';
        folderHeader.classList.remove('collapsed');
      } else {
        folderContent.style.display = 'none';
        folderHeader.classList.add('collapsed');
      }
    };
    
    for(const y in subjectsData[ay]){
      for(const s in subjectsData[ay][y]){
        const list=subjectsData[ay][y][s];
        if(list && list.length > 0){
          const section=document.createElement('div');
          section.className="db-section";
          section.innerHTML=`
            <h3>Year ${y} - Semester ${s} (${list.length} subjects)</h3>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr><th>Subject</th><th>Credits</th><th>Type</th></tr>
                </thead>
                <tbody>
                  ${list.slice(0,5).map(sub=>{
                    const name = escapeHtml(sub.name || sub);
                    const credits = sub.credits || 1;
                    const type = sub.type || 'theory';
                    return `
                      <tr>
                        <td class="subject-name">${name}</td>
                        <td><span class="credits-badge">${credits}</span></td>
                        <td><span class="type-badge type-${type}">${type}</span></td>
                      </tr>
                    `;
                  }).join('')}${list.length > 5 ? `<tr><td colspan="3" style="text-align:center;color:#666;font-style:italic;padding:8px;">... and ${list.length - 5} more subjects</td></tr>` : ''}
                </tbody>
              </table>
            </div>
            <div class="db-actions">
              <button class="useBtn" data-ay="${ay}" data-y="${y}" data-s="${s}">‚úÖ Load</button>
              <button class="delBtn" data-ay="${ay}" data-y="${y}" data-s="${s}">üóëÔ∏è Delete</button>
            </div>
          `;
          folderContent.appendChild(section);
        }
      }
    }
    
    yearFolder.appendChild(folderHeader);
    yearFolder.appendChild(folderContent);
    dbContent.appendChild(yearFolder);
  }
  
  // Attach event listeners
  dbContent.querySelectorAll('.useBtn').forEach(btn=>{
    btn.onclick = function(){
      const ay=btn.dataset.ay, y=btn.dataset.y, s=btn.dataset.s;
      academicYearInput.value=ay;
      yearSelect.value=y; yearSelect.onchange();
      semesterSelect.value=s; semesterSelect.onchange();
      dbOverlay.style.display='none';
      showToast(`Loaded ${ay} Year ${y}, Sem ${s}`,"#28a745");
    };
  });
  
  dbContent.querySelectorAll('.delBtn').forEach(btn=>{
    btn.onclick = function(){
      const ay=btn.dataset.ay, y=btn.dataset.y, s=btn.dataset.s;
      if(confirm(`Delete ${ay} Year ${y}, Sem ${s}?`)){
        delete subjectsData[ay][y][s];
        if(Object.keys(subjectsData[ay][y]).length===0) delete subjectsData[ay][y];
        if(Object.keys(subjectsData[ay]).length===0) delete subjectsData[ay];
        localStorage.setItem(storageKey, JSON.stringify(subjectsData));
        btn.closest('.db-section').remove();
        updateStats();
        showToast(`Deleted ${ay} Year ${y}, Sem ${s}`,"#dc3545");
      }
    };
  });
  
  dbOverlay.style.display='block';
};

// Close database overlay
dbClose.onclick = () => {
  dbOverlay.style.display='none';
};

// Go to timetable generator
document.getElementById('goToTimetable').onclick = () => {
  window.location.href = 'timetable-new.htm?dept=' + currentDepartment;
};

// Utility functions
function showToast(msg,color){
  toast.textContent=msg;
  toast.style.background=color;
  toast.style.display='block';
  setTimeout(()=>toast.style.display='none',2000);
}

function escapeHtml(txt){
  if(!txt) return '';
  return txt.toString().replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}

// Initialize
updateStats();
</script>
</body>
</html>